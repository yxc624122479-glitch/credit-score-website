<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>征信评分系统 - AI智能分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Tesseract OCR库 -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        neutral: {
                            100: '#F2F3F5',
                            200: '#E5E6EB',
                            300: '#C9CDD4',
                            400: '#86909C',
                            500: '#4E5969',
                            600: '#272E3B',
                            700: '#1D2129',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .score-ring {
                stroke-dasharray: 283;
                stroke-dashoffset: calc(283 - (283 * var(--score-percent)) / 100);
                transition: stroke-dashoffset 1s ease-in-out, stroke 0.5s ease-in-out;
            }
            .tab-active {
                border-bottom: 2px solid #165DFF;
                color: #165DFF;
                font-weight: 600;
            }
            .upload-area {
                border: 2px dashed #C9CDD4;
                transition: all 0.3s ease;
            }
            .upload-area:hover, .upload-area.drag-over {
                border-color: #165DFF;
                background-color: rgba(22, 93, 255, 0.05);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-white card-shadow sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-credit-card text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-neutral-700">征信评分系统 - AI智能分析</h1>
            </div>
            <div>
                <span class="text-neutral-500 text-sm">1000分制扣分模型 | AI OCR识别</span>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 评分结果卡片 (初始隐藏) -->
        <div id="result-card" class="mb-8 bg-white rounded-xl p-6 card-shadow hidden">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="mb-6 md:mb-0">
                    <h2 class="text-xl font-bold text-neutral-700 mb-2">您的征信评分</h2>
                    <div class="flex items-end">
                        <span id="final-score" class="text-5xl font-bold text-primary">0</span>
                        <span class="text-xl text-neutral-500 ml-2">/ 1000</span>
                    </div>
                    <div id="score-grade" class="mt-2 text-lg font-medium"></div>
                    <div id="approval-result" class="mt-1 text-sm"></div>
                </div>
                
                <!-- 评分圆环 -->
                <div class="relative w-48 h-48">
                    <svg class="w-full h-full" viewBox="0 0 100 100">
                        <!-- 背景圆环 -->
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#F2F3F5" stroke-width="8"></circle>
                        <!-- 进度圆环 -->
                        <circle id="score-circle" class="score-ring" cx="50" cy="50" r="45" fill="none" stroke="#165DFF" stroke-width="8" transform="rotate(-90 50 50)"></circle>
                        <!-- 中心文字 -->
                        <text id="circle-score" x="50" y="55" text-anchor="middle" font-size="20" font-weight="bold" fill="#1D2129"></text>
                    </svg>
                </div>
            </div>
            
            <!-- 扣分详情 -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-neutral-700 mb-4">扣分详情</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="bg-neutral-100 rounded-lg p-4">
                        <div class="text-sm text-neutral-500 mb-1">逾期记录</div>
                        <div class="flex justify-between items-center">
                            <span id="overdue-deduction" class="text-lg font-bold">0</span>
                            <span class="text-xs text-neutral-400">/ 430</span>
                        </div>
                        <div class="w-full bg-neutral-200 rounded-full h-1.5 mt-2">
                            <div id="overdue-bar" class="bg-danger h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-neutral-100 rounded-lg p-4">
                        <div class="text-sm text-neutral-500 mb-1">负债情况</div>
                        <div class="flex justify-between items-center">
                            <span id="debt-deduction" class="text-lg font-bold">0</span>
                            <span class="text-xs text-neutral-400">/ 290</span>
                        </div>
                        <div class="w-full bg-neutral-200 rounded-full h-1.5 mt-2">
                            <div id="debt-bar" class="bg-warning h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-neutral-100 rounded-lg p-4">
                        <div class="text-sm text-neutral-500 mb-1">查询记录</div>
                        <div class="flex justify-between items-center">
                            <span id="inquiry-deduction" class="text-lg font-bold">0</span>
                            <span class="text-xs text-neutral-400">/ 120</span>
                        </div>
                        <div class="w-full bg-neutral-200 rounded-full h-1.5 mt-2">
                            <div id="inquiry-bar" class="bg-primary h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-neutral-100 rounded-lg p-4">
                        <div class="text-sm text-neutral-500 mb-1">信用历史</div>
                        <div class="flex justify-between items-center">
                            <span id="history-deduction" class="text-lg font-bold">0</span>
                            <span class="text-xs text-neutral-400">/ 80</span>
                        </div>
                        <div class="w-full bg-neutral-200 rounded-full h-1.5 mt-2">
                            <div id="history-bar" class="bg-neutral-500 h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-neutral-100 rounded-lg p-4">
                        <div class="text-sm text-neutral-500 mb-1">账户结构</div>
                        <div class="flex justify-between items-center">
                            <span id="account-deduction" class="text-lg font-bold">0</span>
                            <span class="text-xs text-neutral-400">/ 80</span>
                        </div>
                        <div class="w-full bg-neutral-200 rounded-full h-1.5 mt-2">
                            <div id="account-bar" class="bg-neutral-400 h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 优化建议 -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold text-neutral-700 mb-4">优化建议</h3>
                <div id="suggestions" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- 建议内容将动态生成 -->
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button id="reset-btn" class="px-6 py-2 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 rounded-lg transition">
                    <i class="fa fa-refresh mr-2"></i>重新计算
                </button>
            </div>
        </div>

        <!-- 表单卡片 -->
        <div id="form-card" class="bg-white rounded-xl p-6 card-shadow">
            <!-- 选项卡切换 -->
            <div class="flex border-b border-neutral-200 mb-6">
                <div id="tab-upload" class="tab-active px-6 py-3 cursor-pointer">
                    <i class="fa fa-cloud-upload mr-2"></i>AI智能识别
                </div>
                <div id="tab-manual" class="px-6 py-3 cursor-pointer text-neutral-500">
                    <i class="fa fa-keyboard-o mr-2"></i>手动输入
                </div>
            </div>
            
            <!-- AI识别标签页 -->
            <div id="upload-tab-content">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-neutral-700 mb-4">上传征信文件/图片</h2>
                    <p class="text-neutral-500 mb-6">支持上传征信报告照片、截图或PDF文件，系统将自动识别并分析您的征信情况</p>
                    
                    <!-- 文件上传区域 -->
                    <div id="upload-area" class="upload-area rounded-lg p-8 text-center cursor-pointer mb-6">
                        <input type="file" id="file-input" accept="image/*,.pdf" class="hidden">
                        <i class="fa fa-file-text-o text-5xl text-neutral-400 mb-4"></i>
                        <p class="text-neutral-700 mb-2">点击或拖拽文件至此处上传</p>
                        <p class="text-sm text-neutral-500">支持JPG、PNG、PDF格式，单个文件不超过10MB</p>
                    </div>
                    
                    <!-- 支持的文件类型提示 -->
                    <div class="text-sm text-neutral-500 mb-6">
                        <i class="fa fa-info-circle mr-2"></i>
                        建议上传清晰的征信报告截图或照片，包含逾期记录、负债信息、查询记录等关键内容
                    </div>
                </div>
                
                <!-- 识别进度显示 -->
                <div id="progress-container" class="hidden mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-neutral-700">AI识别中...</span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="w-full bg-neutral-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="progress-status" class="text-sm text-neutral-500 mt-2">正在初始化识别引擎...</p>
                </div>
                
                <!-- 识别结果展示 -->
                <div id="recognition-result" class="hidden mb-6">
                    <div class="bg-primary/5 border border-primary/20 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-primary mb-2 flex items-center">
                            <i class="fa fa-check-circle mr-2"></i>识别完成
                        </h3>
                        <p>系统已成功识别您的征信信息，以下是提取的关键数据：</p>
                    </div>
                    
                    <!-- 识别结果预览 -->
                    <div class="bg-neutral-100 rounded-lg p-4 mb-6">
                        <h4 class="font-semibold text-neutral-700 mb-3">识别结果预览</h4>
                        <div id="result-preview" class="space-y-3 text-sm">
                            <!-- 识别结果将动态显示 -->
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="flex space-x-4">
                        <button id="confirm-result-btn" class="px-6 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition">
                            <i class="fa fa-check mr-2"></i>确认并计算评分
                        </button>
                        <button id="edit-manually-btn" class="px-6 py-3 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 rounded-lg transition">
                            <i class="fa fa-pencil mr-2"></i>手动编辑后计算
                        </button>
                    </div>
                </div>
                
                <!-- 识别失败提示 -->
                <div id="recognition-error" class="hidden mb-6">
                    <div class="bg-danger/5 border border-danger/20 rounded-lg p-4">
                        <h3 class="font-semibold text-danger mb-2 flex items-center">
                            <i class="fa fa-exclamation-circle mr-2"></i>识别失败
                        </h3>
                        <p id="error-message" class="text-neutral-700">无法识别文件内容，请尝试上传更清晰的图片或切换到手动输入模式</p>
                    </div>
                    <button id="retry-upload-btn" class="mt-4 px-6 py-2 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 rounded-lg transition">
                        <i class="fa fa-refresh mr-2"></i>重新上传
                    </button>
                </div>
            </div>
            
            <!-- 手动输入标签页 -->
            <div id="manual-tab-content" class="hidden">
                <h2 class="text-xl font-bold text-neutral-700 mb-6">征信数据录入</h2>
                
                <form id="credit-form" class="space-y-8">
                    <!-- 逾期记录部分 -->
                    <div class="border-b border-neutral-200 pb-6">
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa fa-exclamation-circle text-danger mr-2"></i>逾期记录
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-neutral-700 mb-2">是否有呆账或代偿记录？</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="bad_debts" value="1" class="form-radio text-primary">
                                        <span class="ml-2">是</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="bad_debts" value="0" checked class="form-radio text-primary">
                                        <span class="ml-2">否</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label for="overdue_under30" class="block text-neutral-700 mb-2">30天以内逾期次数</label>
                                <input type="number" id="overdue_under30" name="overdue_under30" min="0" max="10" value="0" 
                                    class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="overdue_over90" class="block text-neutral-700 mb-2">90天以上逾期次数</label>
                                <input type="number" id="overdue_over90" name="overdue_over90" min="0" max="10" value="0" 
                                    class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 负债情况部分 -->
                    <div class="border-b border-neutral-200 pb-6">
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa fa-money text-warning mr-2"></i>负债情况
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="online_loans" class="block text-neutral-700 mb-2">网贷笔数</label>
                                <input type="number" id="online_loans" name="online_loans" min="0" max="20" value="0" 
                                    class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                            
                            <div>
                                <label for="credit_card_usage" class="block text-neutral-700 mb-2">信用卡使用率 (%)</label>
                                <input type="number" id="credit_card_usage" name="credit_card_usage" min="0" max="100" value="50" 
                                    class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="total_debt_ratio" class="block text-neutral-700 mb-2">总负债率 (%)</label>
                                <input type="number" id="total_debt_ratio" name="total_debt_ratio" min="0" max="100" value="40" 
                                    class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 查询记录部分 -->
                    <div class="border-b border-neutral-200 pb-6">
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa fa-search text-primary mr-2"></i>查询记录
                        </h3>
                        
                        <div>
                            <label for="recent_inquiries" class="block text-neutral-700 mb-2">近半年征信查询次数</label>
                            <input type="number" id="recent_inquiries" name="recent_inquiries" min="0" max="20" value="2" 
                                class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        </div>
                    </div>
                    
                    <!-- 信用历史部分 -->
                    <div class="border-b border-neutral-200 pb-6">
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa fa-history text-neutral-500 mr-2"></i>信用历史
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-neutral-700 mb-2">是否为纯白户（无任何信用记录）？</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="is_white" value="1" class="form-radio text-primary">
                                        <span class="ml-2">是</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="is_white" value="0" checked class="form-radio text-primary">
                                        <span class="ml-2">否</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label for="first_credit_years" class="block text-neutral-700 mb-2">首笔信贷年限（年）</label>
                                <input type="number" id="first_credit_years" name="first_credit_years" min="0" max="30" value="5" 
                                    class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 账户结构部分 -->
                    <div>
                        <h3 class="text-lg font-semibold text-neutral-700 mb-4 flex items-center">
                            <i class="fa fa-list-alt text-neutral-400 mr-2"></i>账户结构
                        </h3>
                        
                        <div>
                            <label for="credit_card_count" class="block text-neutral-700 mb-2">信用卡持有数量</label>
                            <input type="number" id="credit_card_count" name="credit_card_count" min="0" max="20" value="2" 
                                class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" class="w-full py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition flex items-center justify-center">
                            <i class="fa fa-calculator mr-2"></i>计算征信评分
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white mt-12 py-6 border-t border-neutral-200">
        <div class="container mx-auto px-4 text-center text-neutral-500 text-sm">
            <p>© 2025 征信评分系统 | AI智能识别版 | 1000分制扣分模型</p>
            <p class="mt-2">
                <i class="fa fa-shield mr-2"></i>隐私保障：所有识别数据仅在本地处理，不会上传至服务器
            </p>
        </div>
    </footer>

    <script>
        // 征信评分计算器类
        class CreditScoreCalculator {
            constructor() {
                this.base_score = 1000;
                this.deductions = {
                    overdue: 0,
                    debt: 0,
                    inquiry: 0,
                    history: 0,
                    account: 0
                };
            }
            
            calculate_score(data) {
                // 计算各项扣分
                this.deductions.overdue = this.calculate_overdue_deduction(data);
                this.deductions.debt = this.calculate_debt_deduction(data);
                this.deductions.inquiry = this.calculate_inquiry_deduction(data);
                this.deductions.history = this.calculate_history_deduction(data);
                this.deductions.account = this.calculate_account_deduction(data);
                
                // 计算总分
                const total_deduction = Object.values(this.deductions).reduce((a, b) => a + b, 0);
                return Math.max(0, this.base_score - total_deduction);
            }
            
            calculate_overdue_deduction(data) {
                // 呆账、代偿（直接扣满）
                if (data.bad_debts === 1) {
                    return 430;
                }
                
                let deduction = 0;
                const overdue_under30 = data.overdue_under30;
                const overdue_over90 = data.overdue_over90;
                
                // 优先计算90天以上逾期（更严重）
                if (overdue_over90 >= 4) {
                    deduction = 430; // 严重逾期直接扣满
                } else if (overdue_over90 === 3) {
                    deduction = 380;
                } else if (overdue_over90 === 2) {
                    deduction = 280;
                } else if (overdue_over90 === 1) {
                    deduction = 150;
                } else {
                    // 没有90天以上逾期，计算30天以内逾期
                    if (overdue_under30 >= 6) {
                        deduction = 400;
                    } else if (overdue_under30 === 5) {
                        deduction = 320;
                    } else if (overdue_under30 === 4) {
                        deduction = 240;
                    } else if (overdue_under30 === 3) {
                        deduction = 160;
                    } else if (overdue_under30 === 2) {
                        deduction = 90;
                    } else if (overdue_under30 === 1) {
                        deduction = 40;
                    }
                }
                
                // 如果同时有两种逾期，适当增加扣分但不超过上限
                if (overdue_over90 > 0 && overdue_under30 > 0) {
                    const additional_deduction = overdue_under30 * 10;
                    deduction = Math.min(430, deduction + additional_deduction);
                }
                
                return deduction;
            }
            
            calculate_debt_deduction(data) {
                let deduction = 0;
                
                // 网贷笔数扣分 - 调整为更合理的权重
                const online_loans = data.online_loans;
                if (online_loans > 6) {
                    deduction += 100; // 超过6笔扣100分
                } else if (online_loans > 3) {
                    deduction += online_loans * 15; // 4-6笔每笔扣15分
                } else if (online_loans > 0) {
                    deduction += online_loans * 10; // 1-3笔每笔扣10分
                }
                
                // 信用卡使用率扣分 - 增加分段逻辑
                const credit_card_usage = data.credit_card_usage;
                if (credit_card_usage >= 100) {
                    deduction += 80; // 刷爆扣80分
                } else if (credit_card_usage > 80) {
                    deduction += 50; // 80%-100%扣50分
                } else if (credit_card_usage > 70) {
                    deduction += 30; // 70%-80%扣30分
                }
                
                // 总负债率扣分 - 增加分段逻辑
                const total_debt_ratio = data.total_debt_ratio;
                if (total_debt_ratio > 80) {
                    deduction += 120; // 超过80%扣120分
                } else if (total_debt_ratio > 70) {
                    deduction += 80; // 70%-80%扣80分
                } else if (total_debt_ratio > 60) {
                    deduction += 40; // 60%-70%扣40分
                } else if (total_debt_ratio > 50) {
                    deduction += 20; // 50%-60%扣20分
                }
                
                return Math.min(290, deduction);
            }
            
            calculate_inquiry_deduction(data) {
                const inquiries = data.recent_inquiries;
                
                if (inquiries >= 12) {
                    return 120;
                } else if (inquiries >= 9) {
                    return 100;
                } else if (inquiries >= 6) {
                    return 75;
                } else if (inquiries >= 3) {
                    return 40;
                } else {
                    return 0;
                }
            }
            
            calculate_history_deduction(data) {
                if (data.is_white === 1) { // 纯白户
                    return 60; // 降低纯白户扣分
                } else {
                    const years = data.first_credit_years;
                    if (years <= 1) {
                        return 30; // 1年以内扣30分
                    } else if (years <= 3) {
                        return 20; // 1-3年扣20分
                    } else if (years <= 5) {
                        return 10; // 3-5年扣10分
                    } else {
                        return 0; // 5年以上不扣分
                    }
                }
            }
            
            calculate_account_deduction(data) {
                const card_count = data.credit_card_count;
                
                if (card_count >= 7) {
                    return 50; // 7张及以上扣50分
                } else if (card_count >= 5) {
                    return 30; // 5-6张扣30分
                } else if (card_count >= 4) {
                    return 20; // 4张扣20分
                } else if (card_count === 0) {
                    return 15; // 0张扣15分
                } else {
                    return 0; // 1-3张不扣分（合理数量）
                }
            }
            
            get_deductions() {
                return {...this.deductions};
            }
        }

        // AI征信数据解析器
        class CreditDataParser {
            constructor() {
                this.defaultData = {
                    bad_debts: 0,
                    overdue_under30: 0,
                    overdue_over90: 0,
                    online_loans: 0,
                    credit_card_usage: 50,
                    total_debt_ratio: 40,
                    recent_inquiries: 2,
                    is_white: 0,
                    first_credit_years: 5,
                    credit_card_count: 2
                };
            }
            
            // 解析文本提取征信数据
            parseCreditText(text) {
                const parsedData = {...this.defaultData};
                
                // 转换为小写便于匹配
                const lowerText = text.toLowerCase();
                
                // 检测呆账/代偿
                if (lowerText.includes('呆账') || lowerText.includes('代偿') || lowerText.includes('坏账')) {
                    parsedData.bad_debts = 1;
                }
                
                // 提取逾期次数 - 使用正则表达式匹配数字
                // 匹配"逾期X次"、"逾期次数：X"等模式
                const overdueMatches = lowerText.match(/逾期.*?(\d+)\s*次/g);
                if (overdueMatches) {
                    const overdueNumbers = overdueMatches.map(match => {
                        const num = match.match(/\d+/);
                        return num ? parseInt(num[0]) : 0;
                    });
                    if (overdueNumbers.length > 0) {
                        parsedData.overdue_under30 = Math.min(10, Math.max(...overdueNumbers));
                    }
                }
                
                // 提取90天以上逾期
                const severeOverdueMatches = lowerText.match(/90天.*?逾期|逾期.*?90天/g);
                if (severeOverdueMatches) {
                    parsedData.overdue_over90 = Math.min(10, severeOverdueMatches.length);
                }
                
                // 提取网贷笔数
                const loanMatches = lowerText.match(/网贷.*?(\d+)\s*笔|网络贷款.*?(\d+)\s*笔/g);
                if (loanMatches) {
                    const loanNumbers = loanMatches.map(match => {
                        const num = match.match(/\d+/);
                        return num ? parseInt(num[0]) : 0;
                    });
                    if (loanNumbers.length > 0) {
                        parsedData.online_loans = Math.min(20, Math.max(...loanNumbers));
                    }
                }
                
                // 提取信用卡使用率
                const usageMatches = lowerText.match(/使用率.*?(\d+)%|使用比例.*?(\d+)%/g);
                if (usageMatches) {
                    const usageNumber = usageMatches[0].match(/\d+/);
                    if (usageNumber) {
                        parsedData.credit_card_usage = Math.min(100, parseInt(usageNumber[0]));
                    }
                }
                
                // 提取负债率
                const debtMatches = lowerText.match(/负债率.*?(\d+)%|负债比例.*?(\d+)%/g);
                if (debtMatches) {
                    const debtNumber = debtMatches[0].match(/\d+/);
                    if (debtNumber) {
                        parsedData.total_debt_ratio = Math.min(100, parseInt(debtNumber[0]));
                    }
                }
                
                // 提取查询次数
                const inquiryMatches = lowerText.match(/查询.*?(\d+)\s*次|征信查询.*?(\d+)\s*次/g);
                if (inquiryMatches) {
                    const inquiryNumbers = inquiryMatches.map(match => {
                        const num = match.match(/\d+/);
                        return num ? parseInt(num[0]) : 0;
                    });
                    if (inquiryNumbers.length > 0) {
                        parsedData.recent_inquiries = Math.min(20, Math.max(...inquiryNumbers));
                    }
                }
                
                // 检测纯白户
                if (lowerText.includes('纯白户') || lowerText.includes('无信用记录') || 
                    (lowerText.includes('征信空白') && !lowerText.includes('逾期') && !lowerText.includes('贷款'))) {
                    parsedData.is_white = 1;
                }
                
                // 提取信用年限
                const yearMatches = lowerText.match(/信用.*?(\d+)\s*年|信贷.*?(\d+)\s*年/g);
                if (yearMatches) {
                    const yearNumber = yearMatches[0].match(/\d+/);
                    if (yearNumber) {
                        parsedData.first_credit_years = Math.min(30, parseInt(yearNumber[0]));
                    }
                }
                
                // 提取信用卡数量
                const cardMatches = lowerText.match(/信用卡.*?(\d+)\s*张|贷记卡.*?(\d+)\s*张/g);
                if (cardMatches) {
                    const cardNumbers = cardMatches.map(match => {
                        const num = match.match(/\d+/);
                        return num ? parseInt(num[0]) : 0;
                    });
                    if (cardNumbers.length > 0) {
                        parsedData.credit_card_count = Math.min(20, Math.max(...cardNumbers));
                    }
                }
                
                return parsedData;
            }
            
            // 生成解析结果的文本描述
            generateResultDescription(data) {
                const descriptions = [];
                
                descriptions.push(`呆账/代偿记录：${data.bad_debts === 1 ? '有' : '无'}`);
                descriptions.push(`30天以内逾期次数：${data.overdue_under30}次`);
                descriptions.push(`90天以上逾期次数：${data.overdue_over90}次`);
                descriptions.push(`网贷笔数：${data.online_loans}笔`);
                descriptions.push(`信用卡使用率：${data.credit_card_usage}%`);
                descriptions.push(`总负债率：${data.total_debt_ratio}%`);
                descriptions.push(`近半年征信查询次数：${data.recent_inquiries}次`);
                descriptions.push(`纯白户：${data.is_white === 1 ? '是' : '否'}`);
                descriptions.push(`首笔信贷年限：${data.first_credit_years}年`);
                descriptions.push(`信用卡持有数量：${data.credit_card_count}张`);
                
                return descriptions;
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化类实例
            const calculator = new CreditScoreCalculator();
            const parser = new CreditDataParser();
            
            // DOM元素引用
            const form = document.getElementById('credit-form');
            const resultCard = document.getElementById('result-card');
            const formCard = document.getElementById('form-card');
            const resetBtn = document.getElementById('reset-btn');
            
            // 选项卡元素
            const tabUpload = document.getElementById('tab-upload');
            const tabManual = document.getElementById('tab-manual');
            const uploadTabContent = document.getElementById('upload-tab-content');
            const manualTabContent = document.getElementById('manual-tab-content');
            
            // 上传相关元素
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressStatus = document.getElementById('progress-status');
            const recognitionResult = document.getElementById('recognition-result');
            const resultPreview = document.getElementById('result-preview');
            const recognitionError = document.getElementById('recognition-error');
            const errorMessage = document.getElementById('error-message');
            
            // 按钮元素
            const confirmResultBtn = document.getElementById('confirm-result-btn');
            const editManuallyBtn = document.getElementById('edit-manually-btn');
            const retryUploadBtn = document.getElementById('retry-upload-btn');
            
            // 存储识别结果
            let recognizedData = null;
            
            // 选项卡切换事件
            tabUpload.addEventListener('click', function() {
                tabUpload.classList.add('tab-active');
                tabManual.classList.remove('tab-active');
                uploadTabContent.classList.remove('hidden');
                manualTabContent.classList.add('hidden');
            });
            
            tabManual.addEventListener('click', function() {
                tabManual.classList.add('tab-active');
                tabUpload.classList.remove('tab-active');
                manualTabContent.classList.remove('hidden');
                uploadTabContent.classList.add('hidden');
                
                // 如果有识别结果，自动填充到表单
                if (recognizedData) {
                    fillFormWithData(recognizedData);
                }
            });
            
            // 文件上传事件
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 拖拽上传事件
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    processFile(e.dataTransfer.files[0]);
                }
            });
            
            // 文件选择事件
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    processFile(this.files[0]);
                }
            });
            
            // 处理上传的文件
            function processFile(file) {
                // 检查文件类型
                if (!file.type.match('image.*') && file.type !== 'application/pdf') {
                    showError('不支持的文件类型，请上传图片或PDF文件');
                    return;
                }
                
                // 检查文件大小 (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showError('文件过大，请上传小于10MB的文件');
                    return;
                }
                
                // 显示进度条
                showProgress();
                
                // 使用Tesseract进行OCR识别
                Tesseract.recognize(
                    file,
                    'chi_sim', // 简体中文
                    {
                        logger: m => {
                            // 更新进度
                            if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                updateProgress(progress, '正在识别文本内容...');
                            } else if (m.status === 'loading tesseract core') {
                                updateProgress(20, '正在加载识别引擎...');
                            } else if (m.status === 'initializing tesseract') {
                                updateProgress(30, '正在初始化识别引擎...');
                            } else if (m.status === 'loading language traineddata') {
                                updateProgress(40, '正在加载语言数据...');
                            }
                        }
                    }
                ).then(({ data: { text } }) => {
                    // 解析识别的文本
                    recognizedData = parser.parseCreditText(text);
                    
                    // 显示识别结果
                    showRecognitionResult(recognizedData);
                }).catch(error => {
                    console.error('识别失败:', error);
                    showError('识别失败，请尝试上传更清晰的图片或使用手动输入模式');
                });
            }
            
            // 更新进度显示
            function updateProgress(percent, status) {
                progressBar.style.width = `${percent}%`;
                progressPercentage.textContent = `${percent}%`;
                progressStatus.textContent = status;
            }
            
            // 显示进度条
            function showProgress() {
                progressContainer.classList.remove('hidden');
                recognitionResult.classList.add('hidden');
                recognitionError.classList.add('hidden');
                updateProgress(0, '正在初始化识别引擎...');
            }
            
            // 显示识别结果
            function showRecognitionResult(data) {
                progressContainer.classList.add('hidden');
                recognitionResult.classList.remove('hidden');
                
                // 生成结果描述
                const descriptions = parser.generateResultDescription(data);
                
                // 清空预览区域
                resultPreview.innerHTML = '';
                
                // 添加结果项
                descriptions.forEach(desc => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between';
                    
                    const label = document.createElement('span');
                    label.className = 'text-neutral-700';
                    label.textContent = desc.split('：')[0] + '：';
                    
                    const value = document.createElement('span');
                    value.className = 'font-medium';
                    value.textContent = desc.split('：')[1];
                    
                    div.appendChild(label);
                    div.appendChild(value);
                    resultPreview.appendChild(div);
                });
            }
            
            // 显示错误信息
            function showError(message) {
                progressContainer.classList.add('hidden');
                recognitionError.classList.remove('hidden');
                errorMessage.textContent = message;
            }
            
            // 填充表单数据
            function fillFormWithData(data) {
                // 设置单选按钮
                document.querySelector(`input[name="bad_debts"][value="${data.bad_debts}"]`).checked = true;
                document.querySelector(`input[name="is_white"][value="${data.is_white}"]`).checked = true;
                
                // 设置输入框值
                document.getElementById('overdue_under30').value = data.overdue_under30;
                document.getElementById('overdue_over90').value = data.overdue_over90;
                document.getElementById('online_loans').value = data.online_loans;
                document.getElementById('credit_card_usage').value = data.credit_card_usage;
                document.getElementById('total_debt_ratio').value = data.total_debt_ratio;
                document.getElementById('recent_inquiries').value = data.recent_inquiries;
                document.getElementById('first_credit_years').value = data.first_credit_years;
                document.getElementById('credit_card_count').value = data.credit_card_count;
            }
            
            // 确认结果并计算评分
            confirmResultBtn.addEventListener('click', function() {
                if (recognizedData) {
                    calculateAndShowResults(recognizedData);
                }
            });
            
            // 编辑手动按钮事件
            editManuallyBtn.addEventListener('click', function() {
                tabManual.click();
            });
            
            // 重试上传按钮事件
            retryUploadBtn.addEventListener('click', function() {
                recognitionError.classList.add('hidden');
                fileInput.value = ''; // 重置文件输入
            });
            
            // 添加表单输入验证函数
            function validateFormInput() {
                const numberInputs = document.querySelectorAll('#credit-form input[type="number"]');
                let isValid = true;
                
                numberInputs.forEach(input => {
                    const value = parseInt(input.value);
                    const min = parseInt(input.min) || 0;
                    const max = parseInt(input.max) || Infinity;
                    
                    // 检查数值范围
                    if (isNaN(value) || value < min || value > max) {
                        input.classList.add('border-danger');
                        isValid = false;
                    } else {
                        input.classList.remove('border-danger');
                    }
                });
                
                return isValid;
            }
            
            // 实时验证输入
            document.querySelectorAll('#credit-form input[type="number"]').forEach(input => {
                input.addEventListener('input', validateFormInput);
                input.addEventListener('blur', validateFormInput);
            });
            
            // 表单提交事件
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 验证表单输入
                if (!validateFormInput()) {
                    alert('请检查输入的数值是否在合理范围内！');
                    return;
                }
                
                // 收集表单数据
                const formData = {
                    bad_debts: parseInt(document.querySelector('input[name="bad_debts"]:checked').value),
                    overdue_under30: parseInt(document.getElementById('overdue_under30').value),
                    overdue_over90: parseInt(document.getElementById('overdue_over90').value),
                    online_loans: parseInt(document.getElementById('online_loans').value),
                    credit_card_usage: parseInt(document.getElementById('credit_card_usage').value),
                    total_debt_ratio: parseInt(document.getElementById('total_debt_ratio').value),
                    recent_inquiries: parseInt(document.getElementById('recent_inquiries').value),
                    is_white: parseInt(document.querySelector('input[name="is_white"]:checked').value),
                    first_credit_years: parseInt(document.getElementById('first_credit_years').value),
                    credit_card_count: parseInt(document.getElementById('credit_card_count').value)
                };
                
                // 计算并显示结果
                calculateAndShowResults(formData);
            });
            
            // 计算并显示结果
            function calculateAndShowResults(data) {
                // 计算评分
                const finalScore = calculator.calculate_score(data);
                const deductions = calculator.get_deductions();
                
                // 显示结果
                displayResults(finalScore, deductions, data);
                
                // 滚动到结果区域
                resultCard.classList.remove('hidden');
                resultCard.scrollIntoView({ behavior: 'smooth' });
            }
            
            // 重置按钮点击事件
            resetBtn.addEventListener('click', function() {
                form.reset();
                resultCard.classList.add('hidden');
                tabUpload.click();
                recognitionResult.classList.add('hidden');
                recognizedData = null;
                fileInput.value = '';
                formCard.scrollIntoView({ behavior: 'smooth' });
            });
            
            // 显示结果函数
            function displayResults(score, deductions, formData) {
                // 确保分数在0-1000范围内
                const normalizedScore = Math.max(0, Math.min(1000, score));
                
                // 更新分数显示
                document.getElementById('final-score').textContent = normalizedScore;
                document.getElementById('circle-score').textContent = normalizedScore;
                
                // 设置圆环进度
                const scorePercent = (normalizedScore / 1000) * 100;
                document.getElementById('score-circle').style.setProperty('--score-percent', scorePercent);
                
                // 设置圆环颜色和评级
                if (score >= 850) {
                    document.getElementById('score-circle').style.stroke = '#00B42A';
                    document.getElementById('score-grade').textContent = '优秀';
                    document.getElementById('score-grade').className = 'mt-2 text-lg font-medium text-success';
                    document.getElementById('approval-result').textContent = '审批结果：秒批';
                } else if (score >= 700) {
                    document.getElementById('score-circle').style.stroke = '#165DFF';
                    document.getElementById('score-grade').textContent = '良好';
                    document.getElementById('score-grade').className = 'mt-2 text-lg font-medium text-primary';
                    document.getElementById('approval-result').textContent = '审批结果：人工审核';
                } else if (score >= 600) {
                    document.getElementById('score-circle').style.stroke = '#FF7D00';
                    document.getElementById('score-grade').textContent = '一般';
                    document.getElementById('score-grade').className = 'mt-2 text-lg font-medium text-warning';
                    document.getElementById('approval-result').textContent = '审批结果：谨慎拒绝';
                } else {
                    document.getElementById('score-circle').style.stroke = '#F53F3F';
                    document.getElementById('score-grade').textContent = '较差';
                    document.getElementById('score-grade').className = 'mt-2 text-lg font-medium text-danger';
                    document.getElementById('approval-result').textContent = '审批结果：秒拒';
                }
                
                // 更新各项扣分显示
                document.getElementById('overdue-deduction').textContent = deductions.overdue;
                document.getElementById('debt-deduction').textContent = deductions.debt;
                document.getElementById('inquiry-deduction').textContent = deductions.inquiry;
                document.getElementById('history-deduction').textContent = deductions.history;
                document.getElementById('account-deduction').textContent = deductions.account;
                
                // 更新进度条
                document.getElementById('overdue-bar').style.width = `${(deductions.overdue / 430) * 100}%`;
                document.getElementById('debt-bar').style.width = `${(deductions.debt / 290) * 100}%`;
                document.getElementById('inquiry-bar').style.width = `${(deductions.inquiry / 120) * 100}%`;
                document.getElementById('history-bar').style.width = `${(deductions.history / 80) * 100}%`;
                document.getElementById('account-bar').style.width = `${(deductions.account / 80) * 100}%`;
                
                // 生成优化建议
                generateSuggestions(deductions, formData);
            }
            
            // 生成优化建议
            function generateSuggestions(deductions, formData) {
                const suggestionsContainer = document.getElementById('suggestions');
                suggestionsContainer.innerHTML = '';
                
                // 逾期记录建议
                if (deductions.overdue > 0) {
                    const overdueSuggestion = document.createElement('div');
                    overdueSuggestion.className = 'bg-danger/5 border border-danger/20 rounded-lg p-4';
                    
                    let overdueText = '<h4 class="font-semibold text-danger mb-2">逾期记录优化</h4><ul class="list-disc list-inside text-sm space-y-1">';
                    
                    if (formData.bad_debts === 1) {
                        overdueText += '<li>立即处理呆账、代偿记录</li>';
                    }
                    if (formData.overdue_under30 > 0 || formData.overdue_over90 > 0) {
                        overdueText += '<li>保持至少24个月无新的逾期记录</li>';
                        overdueText += '<li>设置自动还款或还款提醒，避免再次逾期</li>';
                    }
                    if (formData.overdue_over90 > 0) {
                        overdueText += '<li>90天以上逾期影响严重，需特别注意按时还款</li>';
                    }
                    
                    overdueText += '</ul>';
                    overdueSuggestion.innerHTML = overdueText;
                    suggestionsContainer.appendChild(overdueSuggestion);
                }
                
                // 负债情况建议
                if (deductions.debt > 0) {
                    const debtSuggestion = document.createElement('div');
                    debtSuggestion.className = 'bg-warning/5 border border-warning/20 rounded-lg p-4';
                    
                    let debtText = '<h4 class="font-semibold text-warning mb-2">负债优化</h4><ul class="list-disc list-inside text-sm space-y-1">';
                    
                    if (formData.online_loans > 0) {
                        debtText += `<li>当前有${formData.online_loans}笔网贷，建议逐步结清，特别是超过3笔的部分</li>`;
                    }
                    if (formData.credit_card_usage >= 100) {
                        debtText += '<li>信用卡已刷爆，需立即降低使用率至70%以下</li>';
                    } else if (formData.credit_card_usage > 70) {
                        debtText += `<li>信用卡使用率${formData.credit_card_usage}%偏高，建议降低至70%以下</li>`;
                    }
                    if (formData.total_debt_ratio > 70) {
                        debtText += '<li>总负债率超过70%，需制定还款计划降低负债</li>';
                    } else if (formData.total_debt_ratio > 50) {
                        debtText += `<li>总负债率${formData.total_debt_ratio}%偏高，建议控制在50%以下</li>`;
                    }
                    
                    debtText += '</ul>';
                    debtSuggestion.innerHTML = debtText;
                    suggestionsContainer.appendChild(debtSuggestion);
                }
                
                // 查询记录建议
                if (deductions.inquiry > 0) {
                    const inquirySuggestion = document.createElement('div');
                    inquirySuggestion.className = 'bg-primary/5 border border-primary/20 rounded-lg p-4';
                    
                    let inquiryText = '<h4 class="font-semibold text-primary mb-2">查询优化</h4><ul class="list-disc list-inside text-sm space-y-1">';
                    
                    if (formData.recent_inquiries >= 12) {
                        inquiryText += '<li>查询过于频繁，建议暂停3-6个月的信用申请</li>';
                    } else if (formData.recent_inquiries >= 6) {
                        inquiryText += '<li>查询次数较多，建议减少不必要的征信查询</li>';
                    } else if (formData.recent_inquiries >= 3) {
                        inquiryText += '<li>适当控制征信查询频率，避免短期内多次申请</li>';
                    }
                    
                    inquiryText += '<li>只在必要时申请信贷产品，避免盲目查询</li>';
                    inquiryText += '</ul>';
                    inquirySuggestion.innerHTML = inquiryText;
                    suggestionsContainer.appendChild(inquirySuggestion);
                }
                
                // 信用历史建议
                if (deductions.history > 0) {
                    const historySuggestion = document.createElement('div');
                    historySuggestion.className = 'bg-neutral-500/5 border border-neutral-500/20 rounded-lg p-4';
                    
                    let historyText = '<h4 class="font-semibold text-neutral-500 mb-2">信用历史优化</h4><ul class="list-disc list-inside text-sm space-y-1">';
                    
                    if (formData.is_white === 1) {
                        historyText += '<li>作为纯白户，建议适当建立信用记录</li>';
                        historyText += '<li>可申请一张低额度信用卡并按时还款</li>';
                    } else if (formData.first_credit_years <= 3) {
                        historyText += `<li>信用历史较短(${formData.first_credit_years}年)，需继续积累良好记录</li>`;
                    }
                    
                    historyText += '<li>保持长期良好的还款记录，逐步提升信用年限</li>';
                    historyText += '</ul>';
                    historySuggestion.innerHTML = historyText;
                    suggestionsContainer.appendChild(historySuggestion);
                }
                
                // 账户结构建议
                if (deductions.account > 0) {
                    const accountSuggestion = document.createElement('div');
                    accountSuggestion.className = 'bg-neutral-400/5 border border-neutral-400/20 rounded-lg p-4';
                    
                    let accountText = '<h4 class="font-semibold text-neutral-400 mb-2">账户结构优化</h4><ul class="list-disc list-inside text-sm space-y-1">';
                    
                    if (formData.credit_card_count >= 7) {
                        accountText += `<li>持有${formData.credit_card_count}张信用卡过多，建议注销不常用卡片</li>`;
                    } else if (formData.credit_card_count >= 4) {
                        accountText += `<li>持有${formData.credit_card_count}张信用卡较多，可适当精简</li>`;
                    } else if (formData.credit_card_count === 0) {
                        accountText += '<li>建议申请1-2张信用卡建立信用记录</li>';
                    }
                    
                    accountText += '<li>保持合理的信用卡数量(1-3张)，便于管理</li>';
                    accountText += '</ul>';
                    accountSuggestion.innerHTML = accountText;
                    suggestionsContainer.appendChild(accountSuggestion);
                }
                
                // 如果没有需要优化的项目
                if (suggestionsContainer.children.length === 0) {
                    const goodSuggestion = document.createElement('div');
                    goodSuggestion.className = 'bg-success/5 border border-success/20 rounded-lg p-4 text-center';
                    goodSuggestion.innerHTML = '<h4 class="font-semibold text-success mb-2">信用状况良好</h4><p class="text-sm">继续保持当前的信用管理习惯，您的征信状况优秀！</p>';
                    suggestionsContainer.appendChild(goodSuggestion);
                }
            }
        });
    </script>
</body>
</html>
